<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <title>睿胜能效</title>
    <meta name="viewport" content="user-scalable=no,width=device-width,initial-scale=1.0">
    <meta name="author" content="Draco">
    <link rel="stylesheet" href="../wasion/jquery.fullPage.css">
    <link rel="stylesheet" href="../wasion/wasion.css">
</head>

<body>
    <div id="fullpage">
        <div class="section" id="section01"></div>
        <div class="section" id="section02"></div>
        <div class="section" id="section03"></div>
        <div class="section" id="section04"></div>
        <div class="section" id="section05"></div>
        <div class="section" id="section06"></div>
        <div class="section" id="section07"></div>
        <div class="section" id="section08"></div>
        <div class="section" id="section09"></div>
        <div class="section" id="section10"></div>
        <div class="section" id="section11"></div>
        <div class="section" id="section12"></div>
        <div class="section" id="section13"></div>
        <div class="section" id="section14"></div>
        <div class="section" id="section15"></div>
        <div class="section" id="section16"></div>
        <div class="section" id="section17"></div>
    </div>

    <script src="../wasion/jquery.min.js"></script>
    <!-- <script src="../wasion/jquery.easings.min.js"></script> -->
    <script src="../wasion/jquery.fullPage.min.js"></script>
    <script src="../wasion/snap.svg-min.js"></script>
    <script type="text/javascript">
    var flag = 0,
    defDuration = 1200,
    defEase = mina.easeinout,
    jqCache = {},
    svgCache = {},
    timeouts = [],
    states = {
    	'#path1-1': {
    		o: {
    			transform: 'translate(1280,200)',
            	'fill-opacity': 0
    		},
    		n: {
    			transform: 'translate(0,200)',
            	'fill-opacity': 1
    		}
    	},
    	'#text2-1': {
    		o: {
    			transform: 'translate(-300,0)',
            	'fill-opacity': 0
    		},
    		n: {
    			transform: 'translate(0,0)',
            	'fill-opacity': 1
    		}
    	},
    	'#text2-2': {
    		o: {
    			transform: 'translate(-300,0)',
            	'fill-opacity': 0
    		},
    		n: {
    			transform: 'translate(0,0)',
            	'fill-opacity': 1
    		},
            t: 700
    	},
    	'#g2-1': {
    		o: {
    			transform: 'translate(-100,0)',
            	'stroke-opacity': 0
    		},
    		n: {
    			transform: 'translate(0,0)',
            	'stroke-opacity': 1
    		}
    	},
    	'#text3-1': {
    		o: {
    			transform: 'translate(0,300)',
            	'fill-opacity': 0
    		},
    		n: {
    			transform: 'translate(0,0)',
            	'fill-opacity': 1
    		}
    	},
    	'#img3-1': {
    		o: {
    			transform: 'translate(0,500)',
    			opacity: 0
    		},
    		n: {
				transform: 'translate(0,0)',
				opacity: 1
    		},
            t: defDuration
    	},
    	'.text3-2': {
    		o: {
                'fill-opacity': 0
            },
            n: {
                'fill-opacity': 1
            },
            scale: {
                o: 0,
                n: 1
            },
            t: defDuration * 2
    	},
        '.text4-1': {
            o: {
                transform: 'translate(0,-200)',
                'fill-opacity': 0
            },
            n: {
                transform: 'translate(0,0)',
                'fill-opacity': 1
            },
            d: 700,
            t: 700,
            q: 1
        },
        '#img5-1': {
            o: {
                transform: 'translate(0,900)',
                'opacity': 0
            },
            n: {
                transform: 'translate(0,0)',
                'opacity': 1
            }
        },
        '#img5-2': {
            o: {
                transform: 'translate(0,200)',
                'opacity': 0
            },
            n: {
                transform: 'translate(0,0)',
                'opacity': 1
            }
        },
        '#img5-3': {
            o: {
                transform: 'translate(0,800)',
                'opacity': 0
            },
            n: {
                transform: 'translate(0,0)',
                'opacity': 1
            }
        },
        '#img5-4': {
            o: {
                transform: 'translate(0,500)',
                'opacity': 0
            },
            n: {
                transform: 'translate(0,0)',
                'opacity': 1
            }
        },
        '#img5-5': {
            o: {
                transform: 'translate(0,500)',
                'opacity': 0
            },
            n: {
                transform: 'translate(0,0)',
                'opacity': 1
            }
        },
        '.text5-1': {
            o: {
                'fill-opacity': 0
            },
            n: {
                'fill-opacity': 1
            },
            rotate: {
                o: 0,
                n: 360
            },
            t: defDuration
        }
    },
    components = [
    	['#path1-1'],
    	['#text2-1', '#g2-1', '#text2-2'],
    	['#text3-1', '#img3-1', '.text3-2'],
    	['.text4-1'],
    	['#img5-1', '#img5-2', '#img5-3', '#img5-4', '#img5-5', '.text5-1'],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[],
    	[]
	];

    function _(selector, isJquery) {
		var obj;
		if (isJquery) {
			obj = jqCache[selector];
			if (!obj) {
				obj = $(selector);
				jqCache[selector] = obj;
			}
		} else {
			obj = svgCache[selector];
			if (!obj) {
				obj = selector.indexOf(',') > -1 || selector.indexOf('.') === 0 ? Snap.selectAll(selector) : Snap.select(selector);
				svgCache[selector] = obj;
			}
		}
		return obj;
	}

	function loadSvg(index, loaded) {
		var i = index - 1,
		cur = flag;
		if (!(cur >> i & 1))
			Snap.load('../wasion/svg/' + index + '.svg?d=' + (+new Date), function(d) {
				this.appendChild(d.node);
				flag |= 1 << i;
				var comp = components[i];
				for (var j = 0, l = comp.length; j < l; j++)
					attr(comp[j]);
				loaded && loaded(d);
			}, _('.section', 1)[i]);
	}

    function trans(el, state, duration, ease, callback) {
        var r = state.rotate,
        s = state.scale,
        bbox = r || s ? el.getBBox() : null;
        if (bbox) {
            Snap.animate(0, 1, function(v) {
                var matrix = new Snap.Matrix();
                if (r) {
                    var angle = r.o + (r.n - r.o) * v;
                    matrix.rotate(angle, bbox.cx, bbox.cy);
                }
                if (s) {
                    var rate = s.o + (s.n - s.o) * v;
                    matrix.scale(rate, rate, bbox.cx, bbox.cy);
                }
                el.transform(matrix);
            }, duration || 0, ease, callback);
        }
    }

	function attr(selector) {
		var els = _(selector),
        s = states[selector];
		if (els.stop) {
			els.stop().attr(s.o);
            trans(els, s);
		} else {
			els.forEach(function(el){
				el.stop();
                trans(el, s);
			}).attr(states[selector].o);
		}
	}

    function timeout(els, s, t, d, e, callback) {
        timeouts.push(setTimeout(function() {
            if (s.n) {
                if (s.q && !els.stop) {
                    var tg = -t;
                    els.forEach(function(el){
                        tg += t;
                        timeouts.push(setTimeout(function() {
                            el.animate(s.n, d, e, callback);
                        }, tg));
                    });
                } else {
                    els.animate(s.n, d, e, callback);
                }
            }
                
            if (s.scale || s.rotate) {
                if (els.stop) {
                    trans(els, s, d, e, callback);
                } else {
                    if (s.q) {
                        var ti = -t;
                        els.forEach(function(el){
                            ti += t;
                            timeouts.push(setTimeout(function() {
                                trans(el, s, d, e, callback);
                            }, ti));
                        });
                    } else {
                        els.forEach(function(el){
                            trans(el, s, d, e, callback);
                        });
                    }
                }
            }
        }, t));
    }

	function animate(selector, duration, ease, callback) {
        var s = states[selector],
        d = duration || s.d || defDuration,
        e = ease || defEase,
        t = s.t || 0;
        els = _(selector);

        if (t) {
            timeout(els, s, t, d, e, callback);
        } else {
            if (s.n)
                els.animate(s.n, d, e, callback);
            if (s.scale || s.rotate) {
                if (els.stop) {
                    trans(els, s, d, e, callback);
                } else {
                    els.forEach(function(el){
                        trans(el, s, d, e, callback);
                    });
                }
            }
        }
	}

    $(function() {
    	var count = _('.section', 1).length,
    	preload = 4;

        $('#fullpage').fullpage({
        	verticalCentered: false,

            afterRender: function() {
            	loadSvg(1, function(d) {
        			animate('#path1-1');

	                for (var i = 1; i <= preload; i++)
	                	loadSvg(1 + i);
            	});
            },

            afterLoad: function(anchorLink, index) {
            	var preIndex = index + preload,
            	i = index - 1,
                comp = components[i];
            	if (preIndex <= count)
            		loadSvg(preIndex);

                for (var j = 0, l = comp.length; j < l; j++) {
                	animate(comp[j]);
                };
            },

            onLeave: function(index, newIndex, direction) {
            	while (timeouts.length) {
            		clearTimeout(timeouts.pop());
            	}
                // if (index == 1 && direction == 'down') {
                // }
                var i = index - 1,
                comp = components[i];
                for (var j = 0, l = comp.length; j < l; j++) {
                	attr(comp[j]);
                };
            }
        });
    });
    </script>
</body>

</html>
